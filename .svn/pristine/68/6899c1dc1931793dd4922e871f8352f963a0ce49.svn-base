#include "BathyData.h"


BathyData::BathyData()
{
	x_in_m = 2000.0f;
	y_in_m = 2000.0f;
	depth_in_m = 1.0f;
	depth_negative = false;
}


BathyData::~BathyData()
{
}

bool BathyData::LoadFromFile(std::string FileName, irr::IrrlichtDevice *device)
{
	if (LoadFromXMLFile(FileName,device))
	{
		std::cout << "XML metadata read succesfully.\n";
		return true;
	}
	//If XML reading didn't succeed, then let's try to read as regular ascii file.
	reset_metadata();
	std::cout << "No recognizable xml data, trying as pure ascii\n";
	depths.clear();
	std::fstream fp;
	fp.open(FileName, std::ios::in);
	cell_sizes.clear();
	unsigned int x = 0;
	unsigned int y = 0;
	if (fp.is_open())
	{
		float number;
		std::string tmp;
		while (std::getline(fp, tmp, '\n'))
		{
			y = 0;
			std::string tmp2;
			std::istringstream iss(tmp);
			while (std::getline(iss, tmp2, ' '))
			{
				number = (float)atof(tmp2.c_str());
				if (!depth_negative)
					number *= -1.0f;
				if (number > 0.0f)
					number = 0.0f;
				depths.push_back(number);
				y++;
				cell_sizes.setX(bm_max(cell_sizes.getX(), x));
				cell_sizes.setY(bm_max(cell_sizes.getY(), y));
			}
			x++;
		}
		std::cout << "Ascii data  read succesfully.\n";
	}
	else
		return false;
	fp.close();
	return true;
}

bool BathyData::LoadFromXMLFile(std::string FileName, irr::IrrlichtDevice *device)
{
	if (device == NULL)
		return false;
	irr::io::IXMLReader *xml = device->getFileSystem()->createXMLReader(irr::core::stringw(FileName.c_str()).c_str());
	if (!xml)
	{
		return false;
	}
	bool got_data = false;
	irr::core::stringw current_block = L"";
	while (xml->read())
	{
		switch (xml->getNodeType())
		{
			case irr::io::EXN_ELEMENT:
			{
				if (((irr::core::stringw) xml->getNodeName()).equals_ignore_case("depth_negative"))
				{
					depth_negative = xml->getAttributeValueAsInt(0)!=0;
				}
				if (((irr::core::stringw) xml->getNodeName()).equals_ignore_case("data"))
				{
					current_block = ((irr::core::stringw) xml->getNodeName());
				}
			}
			break;
			case irr::io::EXN_TEXT:
			{
				if (current_block.equals_ignore_case("data"))
				{
					std::istringstream data(wchar2str(xml->getNodeData()));
					depths.clear();
					cell_sizes.clear();
					unsigned int x = 0;
					unsigned int y = 0;
					float number;
					std::string tmp;
					while (std::getline(data, tmp, '\n'))
					{
						y = 0;
						std::string tmp2;
						std::istringstream iss(tmp);
						while (std::getline(iss, tmp2, ' '))
						{
							number = (float)atof(tmp2.c_str());
							if (!depth_negative)
								number *= -1.0f;
							if (number > 0.0f)
								number = 0.0f;
							depths.push_back(number);
							y++;
							cell_sizes.setX(bm_max(cell_sizes.getX(), x));
							cell_sizes.setY(bm_max(cell_sizes.getY(), y));
						}
						x++;
					}
				}
				got_data = true;
			}
			break;
			case irr::io::EXN_ELEMENT_END:
			{
				current_block = "";
			}
			break;
		}
	}
	xml->drop();
	return got_data;
}


bool BathyData::CreateEmpty(int X_cells, int Y_cells)
{
	depths.clear();
	cell_sizes.clear();
	cell_sizes.setX(X_cells);
	cell_sizes.setY(Y_cells);
	depths.clear();
	depths.resize(X_cells*Y_cells, 0.0f);
	return true;
}

void BathyData::reset_metadata()
{
	depth_negative = false;
}

void BathyData::AddRandomNoise(float delta)
{
	for (long i = 0; i < depths.size(); i++)
	{
		if (depths[i] < 0.0f)
		{
			depths[i] = bm_min(0,depths[i]+delta*(1.0f-2.0f*bm_rnd()));
		}
	}
}
